// Payment Approval App - Prisma Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

model User {
  id          String   @id @default(cuid())
  name        String
  email       String   @unique
  department  String
  role        String   @default("user") // user, manager, senior_manager, executive
  createdAt   DateTime @default(now())
  
  // Relations
  requestsCreated   PaymentRequest[] @relation("Requester")
  requestsToApprove PaymentRequest[] @relation("CurrentApprover")
  approvalActions   ApprovalStep[]
  
  // Workflow relations
  createdWorkflows  Workflow[] @relation("WorkflowCreator")
  approvedWorkflows Workflow[] @relation("WorkflowApprover")
}

model PaymentRequest {
  id            String   @id @default(cuid())
  
  // Invoice details
  vendorName    String
  invoiceNumber String
  invoiceDate   DateTime
  amount        Float
  currency      String   @default("ZAR")
  description   String?
  
  // VAT details
  vatCharged        Boolean @default(false)
  internalVatNumber String?
  externalVatNumber String?
  
  // Workflow
  status        String   @default("draft") // draft, pending, approved, rejected
  
  requesterId       String
  requester         User   @relation("Requester", fields: [requesterId], references: [id])
  
  currentApproverId String?
  currentApprover   User?  @relation("CurrentApprover", fields: [currentApproverId], references: [id])
  
  // Active workflow tracking
  workflowId        String?
  workflow          Workflow? @relation(fields: [workflowId], references: [id])
  currentStepIndex  Int       @default(0)
  
  // Relations
  documents       Document[]
  approvalHistory ApprovalStep[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Workflow {
  id          String   @id @default(cuid())
  name        String
  description String?
  status      String   @default("pending_approval") // pending_approval, active, inactive
  
  steps       WorkflowStep[]
  requests    PaymentRequest[]
  
  creatorId   String
  creator     User     @relation("WorkflowCreator", fields: [creatorId], references: [id])
  
  approverId  String?
  approver    User?    @relation("WorkflowApprover", fields: [approverId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model WorkflowStep {
  id          String   @id @default(cuid())
  order       Int
  name        String?
  
  // Requirements
  minAmount   Float    @default(0)
  roleRequirement String // manager, senior_manager, executive
  
  workflowId  String
  workflow    Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)
}

model Document {
  id        String   @id @default(cuid())
  name      String
  mimeType  String
  size      Int
  path      String   // File system path in /uploads
  
  requestId String
  request   PaymentRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  
  uploadedAt DateTime @default(now())
}

model ApprovalStep {
  id         String   @id @default(cuid())
  
  status     String   // pending, approved, rejected
  comments   String?
  
  approverId String
  approver   User   @relation(fields: [approverId], references: [id])
  
  requestId  String
  request    PaymentRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  
  actionedAt DateTime @default(now())
}
